---
title: 'Pre-process TSCA2019 MEA Acute data'
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
    df_print: paged
date: "May 11, 2023"
---

# Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries

```{r}
rm(list = ls())
library(data.table)
library(openxlsx)
library(stringi)
library(ggplot2)

print(sessionInfo())
```


## Project variables definitions

```{r}
project_name <- "TSCA2019" # e.g. "name2020"

spidmap_file <- "L:/Lab/NHEERL_MEA/Project TSCA 2019/EPA_25092_EPA-Shafer_339_20190722.xlsx"
spid_sheet <- 1 # sheet name in spidmap_file

project.input.dir <- "L:/Lab/NHEERL_MEA/Project TSCA 2019/Acute TSCA Conc Response"
scripts.dir <- "mea-acute-neural-stats-to-mc0-scripts"
root.output.dir <- ""
assay_component_map_filename <- file.path("neural_stats_acsn_to_tcpl_acnm_map.xlsx")

project.output.dir <- file.path(root.output.dir, project_name)
project.output.dir <- sub('^/','',project.output.dir) # remove leading /, if present

select.neural.stats.files <- F # select new neural stats files, or use the files in the most recent neural_stats_files_log?
select.calculations.files <- F # select new calculations files, or use the files in the most recent calculations_files_log?
select.raw.cytotox.files <- F # select new raw cytotoxicity files, or use the files in the most recent raw_cytotox_files_log?
run.type.tag.location <- NULL # neural stats files should be named as "tag1_tag2_tag3_....csv". Which tag in the file names defines the run type?

# optional adjutsment; usually can use defaults:
override_wllq_checks <- FALSE # set to TRUE only if you have already verified your wllq updates
plate.id.tag.location <- numeric(0) # only update this if you have to, if your dataset does not include plate.id.tag in file headers
noisy_functions <- FALSE
standard_analysis_duration_requirement <- TRUE # default should be true (recordings that are shorten than this length will be set to wllq == 0)
```

# Load dat3

```{r}
load('TSCA2019/output/TSCA2019_dat3.RData')
```


# Do I agree with plates to be discarded...?

Goal: 

Decide if I'm going to leave the wllq as 0 or 1 in the wllq table..

```{r}
dat3[, wllq_plot := wllq]
dat3[wllq_notes == 'plate has low controls quality, noted in lab notebook QC notes; ', wllq_plot := 'proposed wllq = 0'] # note where this is the only wllq note

dat3[acnm == 'CCTE_Shafer_MEA_acute_firing_rate_mean', individual_well_coff_lb := 0.6377603]
dat3[acnm == 'CCTE_Shafer_MEA_acute_active_electrodes_number', individual_well_coff_lb := 10]

plot.acnms <- paste0('CCTE_Shafer_MEA_acute_',c('firing_rate_mean_weighted','firing_rate_mean','active_electrodes_number'))
ggplot(dat3[(wllt == 'n' | cndx %in% c(1,2)) & acnm %in% plot.acnms], aes(x = full_plate_id, y = activity_value.b)) +
  geom_jitter(aes(color = wllq_plot), height = 0, width = 0.1, pch = 1)+
  scale_color_manual(values = c('0' = 'red','1' = 'black','proposed wllq = 0' = 'orange'))+
  geom_hline(aes(yintercept = individual_well_coff_lb), lty = 'dashed')+
  facet_grid(rows = vars(acnm), scales = 'free')+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))


```

I'm guessing that the number of active electrodes was driving the bus here...


```{r}
dat3[, platewise_med_controls := median(activity_value.b[(wllt == 'n' | cndx %in% c(1,2)) & wllq_plot != '0']), by = .(full_plate_id, acnm)]
plot.acnms <- paste0('CCTE_Shafer_MEA_acute_',c('active_electrodes_number'))
ggplot(dat3[(wllt == 'n' | cndx %in% c(1,2)) & acnm %in% plot.acnms], aes(x = full_plate_id, y = activity_value.b)) +
  # geom_jitter(aes(color = wllq_plot), height = 0, width = 0.1, pch = 1)+
  geom_point(aes(y = platewise_med_controls, color = wllq_plot))+
  scale_color_manual(values = c('0' = 'red','1' = 'black','proposed wllq = 0' = 'orange'))+
  geom_hline(aes(yintercept = individual_well_coff_lb), lty = 'dashed')+
  facet_grid(rows = vars(acnm), scales = 'free')+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))

```

My concern:

* I don't want to set wllq == 0 based on an inconsistently applied threshold

OPtions:

* Just close your eyes adn apply the threshold
* Say - nope, this was just their suggestion, i'm going to make up my own threshold now
* propose to have a conversation with the lab -> yeah, that's the way

How to communicate this to Kelly? 

Idea:

* have in wllq table, but leave wllq = 1
* include a plot here
* inclue in TSCA data prep notes to Kelly
Sure!


# How many wells affected by MFR / nAE coff?

```{r}
load('TSCA2019/output/TSCA2019_dat3.RData')
load('lvl0_snapshots/dat4_2020-07-29.RData')
alldat <- rbind(dat4, dat3, fill = T)
alldat[is.na(project), project := stri_extract(dat3, regex = '^[^_]+')]


alldat[wllq == 0, .N, by = .(wllq_notes)]

check.wllq.notes <- c("Baseline # of AE < 10; ",
                      "Baseline # of AE < 10; ; ",
                      "Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz; ",
                      "Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz; ; ",
                      "Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz; plate has low controls quality, noted in lab notebook QC notes; ",
                      "Baseline # of AE < 10; plate has low controls quality, noted in lab notebook QC notes; ",
                      "Baseline MFR < 0.6377603 Hz; ",
                      "Baseline MFR < 0.6377603 Hz; ; ",
                      "Baseline MFR < 0.6377603 Hz; DMSO % change MFR > 2*SD from the mean; ",
                      "Baseline MFR < 0.6377603 Hz; plate has low controls quality, noted in lab notebook QC notes; ",
                      "Baseline MFR > 3.4036511 Hz; ",
                      "Baseline MFR > 3.4036511 Hz; ; ",
                      "Baseline MFR > 3.4036511 Hz; DMSO % change MFR > 2*SD from the mean; ",
                      "Baseline MFR > 3.4036511 Hz; plate has low controls quality, noted in lab notebook QC notes; ")
length(check.wllq.notes) # 14
setdiff(check.wllq.notes, alldat$wllq_notes) # empty
alldat[wllq_notes %in% check.wllq.notes, .N, by = .(wllq_notes)]



# Well counts
alldat[is.na(plate.id)] # empty
alldat[, full_well_id := paste(experiment.date, plate.id, rowi, coli, sep = '_')]
alldat[is.na(full_well_id)] # empty

# Total
alldat[, length(unique(full_well_id))] # 20879

# Total with one of these notes
alldat[wllq_notes %in% check.wllq.notes, length(unique(full_well_id))]
# 3232

# Confirm that wells affected by these notes have wllq == 0 for ALL endpoints
alldat[, affected_well := any(wllq_notes %in% check.wllq.notes, na.rm = T), by = .(full_well_id)]
alldat[, has_target_wllq_note := wllq_notes %in% check.wllq.notes]
alldat[, .(length(unique(has_target_wllq_note))), by = .(full_well_id)][, .N, by = .(V1)]
# several cases V1 = 2
alldat[!project %in% 'TSCA2019', .(length(unique(has_target_wllq_note))), by = .(full_well_id)][, .N, by = .(V1)]
# even here too

# ARe cyto assays the only source of variability?
alldat[!grepl('(LDH)|(AB)',acnm),  .(length(unique(has_target_wllq_note))), by = .(full_well_id)][, .N, by = .(V1)]
#    V1     N
# 1:  1 19093
# 2:  2   347
# no, even apart from cyto assays there is variability...
alldat[!grepl('(LDH)|(AB)',acnm) & affected_well == TRUE & has_target_wllq_note == FALSE, .N, by = .(wllq, wllq_notes)]
# ahh... these are all of htecases that would hae wllq == 0 for other reasons!


# To simplify, let's grab just the mea, ldh, and ab data
alldat2 <- alldat[acnm %in% paste0('CCTE_Shafer_MEA_acute_',c('LDH','AB','firing_rate_mean'))]

```

For which projects did I set wllq == 0 for LDH/AB wells based on these wllq notes?


```{r}
# First confirm that this check was applied to all projects at all
alldat2[, .N, by = .( has_target_wllq_note, project)][order(project)]
#     has_target_wllq_note     project     N
#  1:                FALSE   APCRA2019  5950
#  2:                 TRUE   APCRA2019  1196
#  3:                FALSE     DNT2019  5217
#  4:                 TRUE     DNT2019   633
#  5:                FALSE      GF2019   449
#  6:                 TRUE      GF2019     1
#  7:                FALSE    TSCA2019 15149
#  8:                 TRUE    TSCA2019  1404
#  9:                FALSE ToxCast2016 27605
# 10:                 TRUE ToxCast2016  2203
# cool, at least 1 wells from every project was affected, so I did apply these checks to all

# In which projects were the LDH/AB wells affected?
alldat2[grepl('(LDH)|(AB)',acnm) & has_target_wllq_note == TRUE, .N, by = .(project)]
#        project    N
# 1: ToxCast2016 1223
# 2:   APCRA2019  720
# 3:     DNT2019  294
# So in these past projects, these wllq notes were applied to the LDH and AB assays as well.
```

How many wells are thrown out because of the high baselien MFR filter?

```{r}
alldat2[wllq_notes %in% c( "Baseline MFR > 3.4036511 Hz; ",
                      "Baseline MFR > 3.4036511 Hz; ; ",
                      "Baseline MFR > 3.4036511 Hz; DMSO % change MFR > 2*SD from the mean; ",
                      "Baseline MFR > 3.4036511 Hz; plate has low controls quality, noted in lab notebook QC notes; "), length(unique(full_well_id))]
# 1134
alldat2[, length(unique(full_well_id))]
# 20879
1134/20879 # 5.4%
```

Old notes:

```{r}

alldat[, total_wells := alldat[, length(unique(full_well_id))]]
res <- alldat[, .(num_wells = length(unique(full_well_id))), 
       by = .(wllq, 
              wllq0_bc_of_baseline_filter = wllq_notes %in% check.wllq.notes,
              total_wells)]
res[, pct_wells := num_wells / total_wells * 100]
res
#    wllq wllq0_bc_of_baseline_filter total_wells num_wells pct_wells
# 1:    1                       FALSE        6930      6652  95.98846
# 2:    0                        TRUE        6930      2118  30.56277
# 3:    0                       FALSE        6930      1565  22.58297

# This does not add up!!

alldat[wllq_notes %in% check.wllq.notes, length(unique(full_well_id)), by = .(project)]
#    project   V1
# 1:     <NA> 1297
# 2: TSCA2019  821

alldat[wllq_notes %in% check.wllq.notes, length(unique(full_well_id)), by = .(mfr_too_high = grepl('Baseline MFR >',wllq_notes))]

```

# Baseline decline

```{r}
load('TSCA2019/output/TSCA2019_dat3.RData')
load('lvl0_snapshots/dat4_2020-07-29.RData')
alldat <- rbind(dat4, dat3, fill = T)
alldat[is.na(project), project := stri_extract(dat3, regex = '^[^_]+')]

# Add the cndx
alldat[is.na(cndx), cndx := frank(conc, ties.method = 'dense'),
       by = .(spid, experiment.date, plate.id, acnm)]

# Plot wllt == 'n' + cndx 1 & 
ggplot(alldat[grepl('firing_rate_mean$',acnm) & wllq == 1 & (wllt == 'n' | (wllt == 't' & cndx %in% c(1,2)))], aes(x = experiment.date, y = rval))+
  geom_point(pch = 1)+
  geom_hline(yintercept = 0)+
  theme_bw()

# Plot just wllt == 'n'
p <- ggplot(alldat[grepl('firing_rate_mean$',acnm) & wllq == 1 & (wllt == 'n')], aes(x = experiment.date, y = rval))+
  geom_point(aes(color = project), pch = 1, stroke = 1.5)+
  geom_hline(yintercept = 0)+
  ylab('% change in MFR by well')+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  ggtitle('% Change in Mean Firing Rate (from baseline to treated recording) in wllt = n wells\nfor all MEA Acute data pre-processed to date',
          subtitle = 'wllq = 1 wells only are shown')
ggsave(plot = p, filename = 'TSCA2019/figs/percent_change_firing_rate_mean_wllt_n_wllq1_all_MEA_acute_2023-08-01.png',
       width = 15, height = 8)
```

# TSCA2019 number of usable replciates

```{r}
dat3[, num_usable_reps := length(unique(full_well_id[wllq == 1])), by = .(treatment, conc)]
dat3[wllt == 't', .N, by = .(num_usable_reps)]

dat3[, num_usable_concs := length(unique(conc[wllq == 1])), by = .(spid, acnm)]
dat3[wllt == 't', .(num_spid_acnm = length(unique(paste0(spid,acnm)))), by = .(num_usable_concs)][order(num_usable_concs)]
```

# wllq in LDH/AB wells when MFR is high in past data

```{r}
load('lvl0_snapshots/dat4_2020-07-29.RData')
dat4[grepl('(LDH)|(AB)',acnm), .N, by = .(wllq, wllq_notes)]
#     wllq                                                                                                             wllq_notes     N
#  1:    1                                                                                                                        26463
#  2:    0                                                                                          Baseline MFR < 0.6377603 Hz;   1336
#  3:    0                                                                   Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz;    713
#  4:    0                                                                                                Baseline # of AE < 10;    186
#  5:    0                                                                                                           rval is NA;    176
#  6:    0                                                                                                            Mis-dosed;     46
#  7:    0 Less than half of typical value, likely that some well contents spilled out. Don't want to include for normalization;      3
#  8:    0                                                                               DMSO % change MFR > 2*SD from the mean;     74
#  9:    0                                                                    Mis-dosed; DMSO % change MFR > 2*SD from the mean;      2
# 10:    0                                                  Baseline MFR < 0.6377603 Hz; DMSO % change MFR > 2*SD from the mean;      2
# 11:    0                                                       Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz; rval is NA;      3
# 12:    0                                                                              Baseline MFR < 0.6377603 Hz; rval is NA;     14
# 13:    0                                                    Baseline # of AE < 10; Baseline MFR < 0.6377603 Hz; Contamination;     20
# 14:    0                                                                                                    Excessive foaming;      2
# 15:    0                                                                                                Did not get full dose;      4
# 16:    0                                                                   Most likely contaminated with LDH positive control;      2
```

Things that seem not good:

* DMSO % change MFR > 2*SD from the mean; 

That's it!