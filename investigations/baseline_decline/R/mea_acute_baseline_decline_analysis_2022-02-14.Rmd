---
title: "MEA Acute Baseline Decline Analysis Feb 14 2022"
author: "Amy Carpenter"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
library(data.table)
library(ggplot2)

# source all functions in folder 'mea-acute-neural-stats-to-mc0-scripts'
scripts <- list.files(path = "../mea-acute-neural-stats-to-mc0-scripts", pattern = "\\.R$", full.names = T, recursive = F)
sapply(scripts, source)
# Note: on branch "experimental1"

```


```{r}
# load data
dat1 <- get_latest_dat(lvl = "dat1", 'BaselineDeclineAnalysis')


# Select a plate
dat1[, .N, by = .(apid, plate.id, maestro_type_foldername, srcf)]

# let's make a plot of a given parameter value...
setkey(dat1, acnm, experiment.date, plate.id, maestro_type_foldername)
select_rows <- data.table(acnm = 'CCTE_Shafer_MEA_acute_firing_rate_mean_weighted',
                          experiment.date = '20220128',
                          plate.id = 'MW78-6310',
                          maestro_type_foldername = 'Maestro Pro 2')
plotdat <- dat1[.(select_rows)]

ggplot(plotdat, aes(x = min_after_exp_start_time, y = activity_value)) +
  geom_line(aes(group = well))+
  geom_point()+
  ggtitle(paste0('Baseline Recordings\n',
  unique(plotdat$acnm),
  '\n',unique(plotdat$experiment.date),', ',unique(plotdat$plate.id),', ',unique(plotdat$maestro_type_foldername)))


```

Some intersting takeaways:

- Interesting how uniformly the wells dip at 120, increase at 200, then all really dip to about 0.25 Hz (15 spikes per min) (and variance significantly decreases) at 260ish. Then slight increase at 320?


Let's try normalizing to the starting value, as Kathleen did
```{r}
dat1[, recording_rank := frank(sec_after_exp_start_time, ties.method = 'dense'), by = .(experiment.date, plate.id, maestro_type_foldername)]
dat1[, activity_value_start := activity_value[recording_rank == 1], by = .(experiment.date, plate.id, maestro_type_foldername, well, acnm)]
dat1[, activity_value_normalized_start := activity_value/activity_value_start*100]

# Plot it
setkey(dat1, acnm, experiment.date, plate.id, maestro_type_foldername)
select_rows <- data.table(acnm = 'CCTE_Shafer_MEA_acute_firing_rate_mean_weighted',
                          experiment.date = '20220128',
                          plate.id = 'MW78-6310',
                          maestro_type_foldername = 'Maestro Pro 2')
plotdat <- dat1[.(select_rows)]

ggplot(plotdat, aes(x = min_after_exp_start_time, y = activity_value_normalized_start)) +
  geom_line(aes(group = well))+
  geom_point()+
  ggtitle(paste0('Baseline Recordings\n',
  unique(plotdat$acnm),
  '\n',unique(plotdat$experiment.date),', ',unique(plotdat$plate.id),', ',unique(plotdat$maestro_type_foldername)))
```

Do other plates have a similar up/down pattern?
```{r}
# Select a plate
dat1[, .N, by = .(apid, plate.id, maestro_type_foldername, srcf)]
select_rows <- data.table(acnm = 'CCTE_Shafer_MEA_acute_firing_rate_mean_weighted',
                          experiment.date = '20220128',
                          plate.id = 'MW78-6311',
                          maestro_type_foldername = 'Maestro Pro 1')
plotdat <- dat1[.(select_rows)]

ggplot(plotdat, aes(x = min_after_exp_start_time, y = activity_value_normalized_start)) +
  geom_line(aes(group = well))+
  geom_point()+
  ggtitle(paste0('Baseline Recordings\n',
  unique(plotdat$acnm),
  '\n',unique(plotdat$experiment.date),', ',unique(plotdat$plate.id),', ',unique(plotdat$maestro_type_foldername)))
```

This is different - uniform/more consistent decrease.

(general goal: see how I like to view it, then create e.g. pdfs of all)
then check out other endpoints.


Specific things I could check out:

- Just view a set of these plots for eveyr plate, for 1 - 3 endpoints
- If I were to calculate the rval, using just time, given no treatment, what would the rval's be? (show how much they decrease)
- How many of the activity values decrease from acceptable to not acceptable ranges over the time period (i.e. for MFR or nAE?)